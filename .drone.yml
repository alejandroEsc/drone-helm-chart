kind: pipeline
name: helm-check

steps:
- name: init
  image: alpine
  environment:
    KUBECONFIG:
      from_secret: KUBECONFIG_ENC
    CHART_NAME: drone
  volumes:
  - name: kubernetes-secrets
    path: /etc/kubernetes
  commands:
  - "echo $KUBECONFIG | base64 -d > /etc/kubernetes/config"
  - "ln -s $(pwd) /etc/kubernetes/$CHART_NAME"


- name: "helm lint and dry run"
  image: keyporttech/helm-builder:2.12.1-1
  environment:
    CHART_NAME: drone
  volumes:
  - name: kubernetes-secrets
    path: /etc/kubernetes
  commands:
  - "cat /etc/kubernetes/config"
  - "helm version --kubeconfig /etc/kubernetes/config"
  - "helm lint /etc/kubernetes/$CHART_NAME --kubeconfig /etc/kubernetes/config"
  - "helm install /etc/kubernetes/$CHART_NAME -n ${DRONE_REPO_NAME}-${DRONE_COMMIT_SHA} --namespace helm-test --dry-run --kubeconfig /etc/kubernetes/config"

- name: "install and test"
  image: keyporttech/helm-builder:2.12.1
  environment:
    CHART_NAME: drone
  volumes:
  - name: kubernetes-secrets
    path: /etc/kubernetes
  commands:
  - "helm delete ${DRONE_REPO_NAME}-${DRONE_COMMIT_SHA} --purge"
  - "helm install . -n ${DRONE_REPO_NAME}-${DRONE_COMMIT_SHA}"

- name: "helm test"
  image: keyporttech/helm-builder:2.12.1
  commands:
  - "helm test ${DRONE_REPO_NAME}-${DRONE_COMMIT_SHA} --cleanup"

- name: "helm update"
  image: keyporttech/helm-builder:2.12.1
  commands:
  - "helm update ${DRONE_REPO_NAME}-${DRONE_COMMIT_SHA} ."

- name: "cleanup"
  image: keyporttech/helm-builder:2.12.1
  commands:
  - "helm delete ${DRONE_REPO_NAME}-${DRONE_COMMIT_SHA} --purge"

# - name: publish
#   image: keyporttech/chart_publisher
#   environment:
#     CHART_NAME: drone_helm_chart
#   commands:
#   - publish
volumes:
- name: kubernetes-secrets
  temp: {}
